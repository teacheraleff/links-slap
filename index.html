<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal do Aluno | SLAP</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=TASA+Orbiter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'TASA Orbiter', sans-serif;
            background-color: #f8fafc; /* stone-50 */
            color: #1c1917; /* stone-900 */
            -webkit-tap-highlight-color: transparent;
        }

        /* Cores da Marca */
        :root {
            --slap-yellow: #F1D24B;
            --slap-orange: #FF5C3D;
            --slap-blue: #84C7DF;
            --slap-purple: #8671D1;
        }

        .bg-slap-yellow { background-color: var(--slap-yellow); }
        .text-slap-yellow { color: var(--slap-yellow); }
        .border-slap-yellow { border-color: var(--slap-yellow); }

        .bg-slap-blue { background-color: var(--slap-blue); }
        .text-slap-blue { color: var(--slap-blue); }

        /* Utilit√°rios */
        .card-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .bottom-nav-item {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .bottom-nav-item.active {
            color: #F1D24B;
        }

        .bottom-nav-item.active::after {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background-color: #F1D24B;
            border-radius: 0 0 4px 4px;
        }

        /* Anima√ß√µes */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scroll horizontal suave */
        .horizontal-scroll {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .horizontal-scroll::-webkit-scrollbar {
            display: none;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-p { background-color: #dcfce7; color: #166534; }
        .status-f { background-color: #fee2e2; color: #991b1b; }
        .status-pp { background-color: #fef3c7; color: #92400e; }
        .status-empty { background-color: #f3f4f6; color: #9ca3af; }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #F1D24B;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-view" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 fade-in">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1751163691/SLAP_TIPO_PRETO_1_xarnpe.png" alt="SLAP Logo" class="h-16 mx-auto mb-4">
                <h1 class="text-2xl font-bold text-stone-800">Portal do Aluno</h1>
                <p class="text-stone-500 text-sm mt-1">Acesse suas aulas, notas e frequ√™ncia</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-stone-700 mb-1">E-mail</label>
                    <input type="email" id="login-email" class="w-full px-4 py-3 rounded-xl border border-stone-200 bg-stone-50 focus:outline-none focus:ring-2 focus:ring-[#F1D24B] focus:border-transparent transition-all" placeholder="seu@email.com" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-stone-700 mb-1">Senha</label>
                    <input type="password" id="login-password" class="w-full px-4 py-3 rounded-xl border border-stone-200 bg-stone-50 focus:outline-none focus:ring-2 focus:ring-[#F1D24B] focus:border-transparent transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <div id="login-error" class="hidden p-3 bg-red-50 text-red-600 text-sm rounded-lg text-center font-medium"></div>

                <button type="submit" class="w-full py-3.5 bg-[#F1D24B] hover:bg-[#eac32a] text-stone-900 font-bold rounded-xl shadow-lg shadow-yellow-100 transition-all transform active:scale-95 flex items-center justify-center">
                    <span id="btn-text">Entrar</span>
                    <div id="btn-loader" class="loader hidden ml-2"></div>
                </button>
                
                <button type="button" onclick="toggleAuthMode('signup')" class="w-full text-sm text-stone-500 hover:text-[#F1D24B] font-medium transition-colors">
                    Primeiro acesso? Cadastre sua senha
                </button>
            </form>

            <!-- Signup Form (Initially Hidden) -->
            <form id="signup-form" class="space-y-5 hidden">
                <div class="text-center mb-2">
                    <h2 class="text-lg font-bold text-stone-800">Criar Acesso</h2>
                    <p class="text-xs text-stone-500">Use o e-mail cadastrado na sua matr√≠cula</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-stone-700 mb-1">E-mail</label>
                    <input type="email" id="signup-email" class="w-full px-4 py-3 rounded-xl border border-stone-200 bg-stone-50 focus:outline-none focus:ring-2 focus:ring-[#F1D24B] focus:border-transparent transition-all" placeholder="seu@email.com" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-stone-700 mb-1">Criar Senha</label>
                    <input type="password" id="signup-password" class="w-full px-4 py-3 rounded-xl border border-stone-200 bg-stone-50 focus:outline-none focus:ring-2 focus:ring-[#F1D24B] focus:border-transparent transition-all" placeholder="M√≠nimo 6 caracteres" minlength="6" required>
                </div>
                
                <div id="signup-error" class="hidden p-3 bg-red-50 text-red-600 text-sm rounded-lg text-center font-medium"></div>

                <button type="submit" class="w-full py-3.5 bg-stone-800 hover:bg-stone-900 text-white font-bold rounded-xl shadow-lg transition-all transform active:scale-95 flex items-center justify-center">
                    <span id="signup-btn-text">Cadastrar</span>
                    <div id="signup-btn-loader" class="loader hidden ml-2" style="border-top-color: white;"></div>
                </button>
                
                <button type="button" onclick="toggleAuthMode('login')" class="w-full text-sm text-stone-500 hover:text-[#F1D24B] font-medium transition-colors">
                    J√° tenho conta. Fazer Login
                </button>
            </form>
            
            <p class="mt-8 text-center text-xs text-stone-400">
                Problemas no acesso? Contate a secretaria.
            </p>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Hidden initially) -->
    <div id="app-view" class="hidden flex-1 flex flex-col h-full bg-stone-50">
        
        <!-- HEADER -->
        <header class="bg-white px-6 pt-12 pb-4 shadow-sm z-10 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center border-2 border-white shadow-sm overflow-hidden">
                    <img id="header-avatar" src="" class="w-full h-full object-cover hidden" alt="Avatar">
                    <span id="header-initials" class="text-[#F1D24B] font-bold text-sm">AL</span>
                </div>
                <div>
                    <p class="text-xs text-stone-500 font-medium">Ol√°,</p>
                    <h2 id="header-name" class="text-lg font-bold text-stone-800 leading-tight">Aluno</h2>
                </div>
            </div>
            <button id="logout-btn" class="p-2 bg-stone-100 rounded-full text-stone-500 hover:text-red-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            </button>
        </header>

        <!-- CONTENT AREA (Scrollable) -->
        <main id="main-content" class="flex-1 overflow-y-auto pb-24 p-6">
            
            <!-- HOME SECTION -->
            <section id="tab-home" class="space-y-6 fade-in">
                <!-- Info Card -->
                <div class="bg-gradient-to-br from-[#1c1917] to-[#2d2a28] rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-[#F1D24B] rounded-full filter blur-3xl opacity-10 transform translate-x-10 -translate-y-10"></div>
                    
                    <div class="relative z-10">
                        <span id="student-modalidade" class="inline-block px-3 py-1 bg-white/10 backdrop-blur-md rounded-full text-xs font-semibold mb-4 border border-white/20">VIP</span>
                        
                        <div class="mb-6">
                            <p class="text-stone-400 text-xs mb-1 uppercase tracking-wider">N√≠vel Atual</p>
                            <h3 id="student-level" class="text-3xl font-bold text-[#F1D24B]">B1 Intermedi√°rio</h3>
                        </div>

                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-stone-400 text-xs mb-1">Professor</p>
                                <p id="student-teacher" class="font-medium">Carregando...</p>
                            </div>
                            <div class="text-right">
                                <p class="text-stone-400 text-xs mb-1">Status</p>
                                <div class="flex items-center gap-1.5">
                                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    <span class="font-medium">Ativo</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 flex flex-col items-center justify-center text-center">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-[#84C7DF] flex items-center justify-center mb-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <p class="text-2xl font-bold text-stone-800" id="stat-attendance">0%</p>
                        <p class="text-xs text-stone-500 font-medium">Assiduidade</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 flex flex-col items-center justify-center text-center">
                        <div class="w-10 h-10 rounded-full bg-purple-50 text-[#8671D1] flex items-center justify-center mb-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <p class="text-2xl font-bold text-stone-800" id="stat-classes">0</p>
                        <p class="text-xs text-stone-500 font-medium">Aulas Feitas</p>
                    </div>
                </div>

                <!-- Biscoito da Sorte -->
                <div class="bg-[#FFFBEB] border border-[#F1D24B]/30 p-5 rounded-xl relative">
                    <div class="flex gap-4">
                        <div class="text-3xl">ü•†</div>
                        <div>
                            <h4 class="font-bold text-stone-800 mb-1">Quote do Dia</h4>
                            <p id="fortune-text" class="text-sm text-stone-600 italic">"O aprendizado √© a √∫nica coisa que a mente nunca se cansa, nunca tem medo e nunca se arrepende."</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PEF SECTION -->
            <section id="tab-pef" class="hidden space-y-6 fade-in">
                <h2 class="text-xl font-bold text-stone-800">Frequ√™ncia (PEF)</h2>
                
                <div class="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden">
                    <div class="p-4 border-b border-stone-100 bg-stone-50 flex justify-between items-center">
                        <span class="text-sm font-semibold text-stone-600">Registro de Aulas</span>
                        <div class="flex gap-2 text-xs">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> P</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> F</span>
                        </div>
                    </div>
                    
                    <div id="pef-grid" class="p-4 grid grid-cols-5 gap-3">
                        <!-- Grid generated via JS -->
                    </div>
                </div>

                <!-- Legend -->
                <div class="grid grid-cols-1 gap-3">
                    <div class="bg-white p-3 rounded-lg border-l-4 border-green-500 shadow-sm">
                        <p class="text-xs text-stone-500">Aulas Presentes</p>
                        <p class="text-lg font-bold text-stone-800" id="pef-present-count">0</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg border-l-4 border-red-500 shadow-sm">
                        <p class="text-xs text-stone-500">Faltas</p>
                        <p class="text-lg font-bold text-stone-800" id="pef-absent-count">0</p>
                    </div>
                </div>
            </section>

            <!-- GRADES SECTION -->
            <section id="tab-grades" class="hidden space-y-6 fade-in">
                <h2 class="text-xl font-bold text-stone-800">Boletim</h2>

                <div class="bg-white rounded-xl shadow-sm border border-stone-100 p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-purple-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                    
                    <div class="relative z-10 text-center mb-8">
                        <p class="text-sm text-stone-500 uppercase tracking-wide font-medium">Nota Final</p>
                        <div class="flex justify-center items-baseline gap-1 mt-2">
                            <span id="final-grade" class="text-5xl font-extrabold text-[#8671D1]">0.0</span>
                            <span class="text-stone-400 font-medium">/ 100</span>
                        </div>
                        <span id="approval-badge" class="inline-block mt-3 px-3 py-1 bg-stone-100 text-stone-500 rounded-full text-xs font-bold uppercase tracking-wider">
                            Pendente
                        </span>
                    </div>

                    <div class="space-y-4 relative z-10" id="grades-list">
                        <!-- Grades injected via JS -->
                    </div>
                </div>

                <div id="teacher-notes-container" class="hidden bg-yellow-50 border border-yellow-200 p-5 rounded-xl">
                    <h4 class="font-bold text-yellow-800 mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                        Observa√ß√£o do Professor
                    </h4>
                    <p id="teacher-notes" class="text-sm text-stone-700 leading-relaxed italic">
                        
                    </p>
                </div>
            </section>

        </main>

        <!-- BOTTOM NAVIGATION -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 px-6 py-3 flex justify-between items-center z-40 pb-safe">
            <button onclick="switchTab('home')" class="bottom-nav-item active flex flex-col items-center gap-1 text-stone-400 p-2" id="nav-home">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="text-[10px] font-bold">In√≠cio</span>
            </button>
            <button onclick="switchTab('pef')" class="bottom-nav-item flex flex-col items-center gap-1 text-stone-400 p-2" id="nav-pef">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span class="text-[10px] font-bold">Aulas</span>
            </button>
            <button onclick="switchTab('grades')" class="bottom-nav-item flex flex-col items-center gap-1 text-stone-400 p-2" id="nav-grades">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <span class="text-[10px] font-bold">Notas</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Global State
        let db, auth;
        let currentStudent = null;
        let currentUnitData = null; // Turma or VIP data
        let attendanceData = null;
        
        // Use environment app ID if available, fallback to specific ID for demo
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hub-gestao-slap';

        // --- CORE FUNCTIONS ---

        async function initApp() {
            // FIX: Retrieve config from environment variable
            let firebaseConfig;
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (error) {
                console.error("Erro ao carregar configura√ß√£o do Firebase:", error);
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Check Auth State
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await handleUserLogin(user.email);
                } else {
                    showLogin();
                }
            });

            // Fortune Cookie
            setFortuneCookie();
        }

        async function handleUserLogin(email) {
            const btnLoader = document.getElementById('btn-loader');
            const btnText = document.getElementById('btn-text');
            const signupLoader = document.getElementById('signup-btn-loader');
            const signupText = document.getElementById('signup-btn-text');
            
            if(btnLoader) btnLoader.classList.remove('hidden');
            if(btnText) btnText.textContent = 'Carregando...';
            if(signupLoader) signupLoader.classList.remove('hidden');
            if(signupText) signupText.textContent = 'Verificando...';

            try {
                // 1. Find Student by Email
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    throw new Error("Aluno n√£o encontrado com este e-mail.");
                }

                const studentDoc = querySnapshot.docs[0];
                currentStudent = { id: studentDoc.id, ...studentDoc.data() };

                // 2. Load Academic Data (Turma or VIP)
                await loadAcademicData();

                // 3. Render UI
                renderStudentProfile();
                renderPEF();
                renderGrades();

                showApp();

            } catch (error) {
                console.error("Login error:", error);
                // Only show error on the active form
                const activeForm = document.getElementById('login-form').classList.contains('hidden') ? 'signup-error' : 'login-error';
                const errorDiv = document.getElementById(activeForm);
                if (errorDiv) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
                
                // If checking auth state failed (e.g. valid auth user but no student record), sign out
                signOut(auth);
                showLogin();
            } finally {
                if(btnLoader) btnLoader.classList.add('hidden');
                if(btnText) btnText.textContent = 'Entrar';
                if(signupLoader) signupLoader.classList.add('hidden');
                if(signupText) signupText.textContent = 'Cadastrar';
            }
        }

        async function loadAcademicData() {
            // Check modality
            const modalidade = (currentStudent.modalidade || 'TURMA').toUpperCase();
            
            if (modalidade === 'VIP' || modalidade === 'DUPLA') {
                // Fetch VIP record
                const vipsRef = collection(db, `artifacts/${appId}/public/data/vips`);
                const q = query(vipsRef, where("studentId", "==", currentStudent.id));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    // Get most recent active VIP contract
                    const vips = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    // Sort by start date desc (assuming mostly sorted)
                    currentUnitData = vips[0]; 
                    currentUnitData.type = 'vip';
                }
            } else {
                // Fetch Turma
                // Find turma where studentId is in studentIds array
                const turmasRef = collection(db, `artifacts/${appId}/public/data/turmas`);
                const q = query(turmasRef, where("studentIds", "array-contains", currentStudent.id));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    // Assume student is in only one active class for now
                    const turmaDoc = snapshot.docs.find(t => !t.data().finalizada);
                    if(turmaDoc) {
                        currentUnitData = { id: turmaDoc.id, ...turmaDoc.data(), type: 'turma' };
                    }
                }
            }

            // Load Attendance
            if (currentUnitData) {
                const attendanceRef = doc(db, `artifacts/${appId}/public/data/attendance`, currentUnitData.id);
                const attSnap = await getDoc(attendanceRef);
                if (attSnap.exists()) {
                    attendanceData = attSnap.data();
                }
            }
        }

        // --- RENDER FUNCTIONS ---

        function renderStudentProfile() {
            // Header
            document.getElementById('header-name').textContent = currentStudent.name.split(' ')[0]; // First name
            document.getElementById('header-initials').textContent = getInitials(currentStudent.name);
            
            // Card
            document.getElementById('student-modalidade').textContent = currentStudent.modalidade || 'TURMA';
            document.getElementById('student-level').textContent = currentUnitData?.level || currentStudent.currentLevel || 'N√≠vel n√£o definido';
            
            const teacherName = currentUnitData?.teacherName || 'N√£o atribu√≠do';
            document.getElementById('student-teacher').textContent = teacherName;
        }

        function renderPEF() {
            const grid = document.getElementById('pef-grid');
            grid.innerHTML = '';
            
            let presentCount = 0;
            let absentCount = 0;
            let totalClasses = 0;

            const lessons = attendanceData?.lessons || {};

            // Render 40 lessons grid
            for (let i = 1; i <= 40; i++) {
                const lesson = lessons[i];
                let status = ''; // P, F, PP, or empty
                let date = '';

                if (lesson && lesson.date) {
                    // Check student status
                    if (currentUnitData.type === 'turma') {
                        status = lesson.students?.[currentStudent.id] || '';
                    } else {
                        // VIP usually has one student, or check specific ID
                        // VIP structure might be simpler or same as turma
                        status = lesson.students?.[currentStudent.id] || ''; 
                        // Fallback for older VIP structure if needed
                        if(!status && lesson.status) status = lesson.status; 
                    }
                    date = lesson.date.split('-').reverse().slice(0,2).join('/'); // DD/MM
                }

                // Stats
                if (status === 'P') presentCount++;
                if (status === 'F') absentCount++;
                if (status === 'PP') presentCount += 0.5; // Partial presence
                if (status) totalClasses++;

                // Visuals
                let bgClass = 'bg-stone-100 text-stone-400';
                let borderClass = 'border-transparent';
                
                if (status === 'P') { bgClass = 'bg-green-100 text-green-700 border-green-200'; }
                else if (status === 'F') { bgClass = 'bg-red-100 text-red-700 border-red-200'; }
                else if (status === 'PP') { bgClass = 'bg-yellow-100 text-yellow-700 border-yellow-200'; }

                const cell = document.createElement('div');
                cell.className = `aspect-square rounded-lg flex flex-col items-center justify-center text-xs font-bold border ${bgClass}`;
                cell.innerHTML = `
                    <span>${i}</span>
                    <span class="text-[9px] font-normal opacity-70">${status || '-'}</span>
                `;
                grid.appendChild(cell);
            }

            // Update stats
            document.getElementById('pef-present-count').textContent = presentCount;
            document.getElementById('pef-absent-count').textContent = absentCount;
            
            // Home Stats
            document.getElementById('stat-classes').textContent = totalClasses;
            const percentage = totalClasses > 0 ? Math.round((presentCount / totalClasses) * 100) : 0;
            document.getElementById('stat-attendance').textContent = `${percentage}%`;
        }

        function renderGrades() {
            let grades = {};
            let obs = "";

            if (currentUnitData?.type === 'turma') {
                grades = currentUnitData.studentGrades?.[currentStudent.id] || {};
                obs = grades.observacao || "";
            } else if (currentUnitData?.type === 'vip') {
                grades = currentUnitData.grades || {};
                obs = grades.observacao || grades.observacoes || "";
            }

            // Default zero
            const getGrade = (val) => parseFloat(val) || 0;

            const scores = [
                { label: 'Midterm', val: getGrade(grades.midtermTest), max: 20 },
                { label: 'Listening', val: getGrade(grades.listeningTest), max: 20 },
                { label: 'Grammar', val: getGrade(grades.grammarTest), max: 20 },
                { label: 'Oral', val: getGrade(grades.oralTest), max: 20 },
                { label: 'Participation', val: getGrade(grades.participacao), max: 10 },
                { label: 'Attendance', val: getGrade(grades.assiduidade), max: 10 },
            ];

            const total = scores.reduce((a, b) => a + b.val, 0);
            
            // Final Grade Display
            document.getElementById('final-grade').textContent = total.toFixed(1);
            
            const badge = document.getElementById('approval-badge');
            if (total >= 70) {
                badge.textContent = "Aprovado";
                badge.className = "inline-block mt-3 px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold uppercase tracking-wider";
            } else if (total > 0) {
                badge.textContent = "Em andamento";
                badge.className = "inline-block mt-3 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold uppercase tracking-wider";
            } else {
                badge.textContent = "Pendente";
                badge.className = "inline-block mt-3 px-3 py-1 bg-stone-100 text-stone-500 rounded-full text-xs font-bold uppercase tracking-wider";
            }

            // List
            const list = document.getElementById('grades-list');
            list.innerHTML = scores.map(s => {
                const percent = (s.val / s.max) * 100;
                return `
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium text-stone-600">${s.label}</span>
                        <span class="font-bold text-stone-800">${s.val}/${s.max}</span>
                    </div>
                    <div class="w-full bg-stone-100 rounded-full h-2.5 overflow-hidden">
                        <div class="bg-[#F1D24B] h-2.5 rounded-full" style="width: ${percent}%"></div>
                    </div>
                </div>
                `;
            }).join('');

            // Observa√ß√µes
            const notesContainer = document.getElementById('teacher-notes-container');
            if (obs) {
                document.getElementById('teacher-notes').textContent = obs;
                notesContainer.classList.remove('hidden');
            } else {
                notesContainer.classList.add('hidden');
            }
        }

        // --- UTILS ---

        function getInitials(name) {
            if (!name) return 'AL';
            const parts = name.trim().split(' ');
            if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }

        function setFortuneCookie() {
            const phrases = [
                "O sucesso √© a soma de pequenos esfor√ßos repetidos dia ap√≥s dia.",
                "Acredite em si mesmo e tudo ser√° poss√≠vel.",
                "Cada novo dia √© uma oportunidade de crescer e aprender.",
                "A persist√™ncia √© o caminho do √™xito.",
                "O aprendizado √© um tesouro que seguir√° seu dono por toda parte.",
                "N√£o pare at√© se orgulhar."
            ];
            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            document.getElementById('fortune-text').textContent = `"${randomPhrase}"`;
        }

        // --- UI HANDLERS ---

        function showLogin() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
        }

        window.toggleAuthMode = function(mode) {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const errorDivs = document.querySelectorAll('#login-error, #signup-error');
            
            // Clear errors
            errorDivs.forEach(div => div.classList.add('hidden'));

            if (mode === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }

        window.switchTab = function(tabName) {
            // Hide all sections
            ['home', 'pef', 'grades'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('active');
            });

            // Show selected
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`nav-${tabName}`).classList.add('active');
            
            // Scroll to top
            document.getElementById('main-content').scrollTo(0,0);
        }

        // --- EVENT LISTENERS ---

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            errorDiv.classList.add('hidden');

            try {
                // Sign in with Firebase Auth (users must exist in Auth)
                await signInWithEmailAndPassword(auth, email, password);
                // Listener will handle redirection
            } catch (error) {
                console.error(error);
                errorDiv.textContent = "E-mail ou senha inv√°lidos. Tente novamente.";
                errorDiv.classList.remove('hidden');
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorDiv = document.getElementById('signup-error');
            const loader = document.getElementById('signup-btn-loader');
            const btnText = document.getElementById('signup-btn-text');
            
            errorDiv.classList.add('hidden');
            loader.classList.remove('hidden');
            btnText.textContent = 'Verificando...';

            try {
                // 1. Verify if email exists in students collection first
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    throw new Error("Este e-mail n√£o est√° cadastrado como aluno. Contate a secretaria.");
                }

                // 2. Create Authentication User
                await createUserWithEmailAndPassword(auth, email, password);
                
                // Success will trigger onAuthStateChanged
            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (error.code === 'auth/email-already-in-use') {
                    msg = "Este e-mail j√° possui cadastro. Fa√ßa login.";
                } else if (error.code === 'auth/weak-password') {
                    msg = "A senha deve ter pelo menos 6 caracteres.";
                }
                errorDiv.textContent = msg;
                errorDiv.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                btnText.textContent = 'Cadastrar';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if(confirm("Deseja sair do portal?")) {
                signOut(auth);
            }
        });

        // Initialize
        initApp();

    </script>
</body>
</html>
